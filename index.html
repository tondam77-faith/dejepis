<!DOCTYPE html>
<html lang="cs">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <link rel="manifest" href="manifest.json">
    <link rel="icon" href="favicon.ico" type="image/x-icon">
    <meta name="theme-color" content="#fdfbf7">
    <title>Dƒõjepis SRS 4.6</title>
    <style>
        :root {
            /* Barvy p≈ôesnƒõ z v1.2 */
            --primary: #1a3a5a; 
            --accent: #e67e22; /* Oran≈æov√° */
            --bg: #fdfbf7;      /* Kr√©mov√© pozad√≠ */
            --card-front: #ffffff;
            --text: #2c3e50;
            
            --success: #27ae60; 
            --danger: #e74c3c; 
            --warning: #f39c12; 
            --info: #3498db;
            
            /* Navigace */
            --nav-height: 65px;
            --safe-bottom: env(safe-area-inset-bottom, 20px);
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

        body {
            font-family: 'Segoe UI', system-ui, sans-serif;
            background-color: var(--bg); margin: 0; 
            height: 100dvh; color: var(--text);
            overflow: hidden; display: flex; flex-direction: column;
        }

        /* --- OBECN√â --- */
        .view {
            flex: 1; overflow-y: auto; padding: 20px;
            padding-bottom: calc(var(--nav-height) + var(--safe-bottom) + 20px);
            display: none; 
        }
        .view.active { display: block; animation: fadein 0.2s; }
        @keyframes fadein { from { opacity: 0; } to { opacity: 1; } }

        h2 { color: var(--primary); text-align: center; margin: 15px 0; font-weight: 800; }
        
        /* --- KARTA (UƒåEN√ç) - SRS POKROK & DESIGN v1.2 --- */
        #learn-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: var(--bg); z-index: 5000;
            display: flex; flex-direction: column;
            padding: 15px;
            overflow-y: auto; 
        }

        .learn-header {
            display: flex; flex-direction: column; gap: 5px; /* Pod sebe pro progress bar */
            margin-bottom: 20px; flex-shrink: 0;
        }
        .header-top { display: flex; justify-content: space-between; align-items: center; width: 100%; }
        
        .pill { font-weight: 800; color: var(--primary); font-size: 0.9rem; }
        .close-btn { background: none; border: none; font-size: 1.5rem; color: #999; cursor: pointer; }

        /* PROGRESS BAR */
        .progress-container {
            width: 100%; height: 6px; background: #e0e0e0; border-radius: 3px; overflow: hidden; margin-top: 5px;
        }
        .progress-fill {
            height: 100%; background: var(--success); width: 0%; transition: width 0.3s ease;
        }

        /* Kontejner karty */
        .fc-container {
            perspective: 1000px; 
            margin-bottom: 20px; 
            display: flex; justify-content: center;
        }
        
        .flashcard {
            position: relative; width: 100%; 
            height: 400px; /* Pevn√° v√Ω≈°ka */
            
            transform-style: preserve-3d; transition: transform 0.6s cubic-bezier(0.4, 0.2, 0.2, 1);
            cursor: pointer;
        }
        .flashcard.flipped { transform: rotateY(180deg); }

        .side {
            position: absolute; width: 100%; height: 100%;
            backface-visibility: hidden; border-radius: 20px;
            background: white; padding: 25px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.08); border: 1px solid rgba(0,0,0,0.02);
            display: flex; flex-direction: column; justify-content: center; align-items: center; text-align: center;
            overflow-y: auto;
        }
        
        .front { z-index: 2; }
        .back { transform: rotateY(180deg); border-top: 5px solid var(--primary); }

        /* Obsah karty */
        .q-deck { text-transform: uppercase; font-size: 0.75rem; color: var(--accent); font-weight: 800; letter-spacing: 1px; margin-bottom: 20px; }
        .q-text { font-size: 1.6rem; font-weight: 800; line-height: 1.4; color: #2c3e50; margin-bottom: 15px; }
        .q-img { max-height: 180px; border-radius: 8px; margin-bottom: 15px; object-fit: contain; }

        /* ODPOVƒöƒé - STYL V1.2 */
        .answer-container { 
            width: 100%; text-align: left; 
            margin-top: 10px; 
        }
        .answer-line {
            padding: 10px 15px; margin-bottom: 8px;
            background: #fff; 
            border-left: 4px solid var(--accent); /* Oran≈æov√° ƒç√°ra */
            font-size: 1.2rem; line-height: 1.4; color: #333; font-weight: 500;
            display: flex; align-items: flex-start;
        }
        .answer-line::before {
            content: "‚Ä¢"; color: var(--accent); font-weight: bold; margin-right: 10px; font-size: 1.2rem;
        }

        /* TTS Ikona */
        .tts-btn { background: none; border: none; font-size: 1.3rem; opacity: 0.4; cursor: pointer; margin-left: 8px; vertical-align: middle; color:var(--primary); }
        .tts-btn:hover { opacity: 1; transform: scale(1.1); }

        /* Tlaƒç√≠tka pod kartou */
        .srs-area { width: 100%; padding-bottom: 40px; }
        .hint-text { text-align: center; color: #999; font-size: 0.8rem; margin-bottom: 15px; }
        
        .srs-buttons { display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; }
        .srs-btn { 
            border: none; border-radius: 12px; font-weight: 700; color: white; 
            padding: 15px 2px; cursor: pointer; display: flex; flex-direction: column; align-items: center;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1); 
        }
        .srs-btn:active { transform: scale(0.96); }
        .srs-btn span { font-size: 0.65rem; font-weight: normal; opacity: 0.9; margin-top: 4px; }
        
        .b-0 { background: var(--danger); }
        .b-1 { background: var(--warning); }
        .b-2 { background: var(--info); }
        .b-3 { background: var(--success); }

        /* --- DOM≈Æ --- */
        .stats-row { display: flex; gap: 15px; margin-bottom: 25px; }
        .stat-box { flex: 1; background: white; padding: 15px; border-radius: 12px; text-align: center; box-shadow: 0 4px 10px rgba(0,0,0,0.03); }
        .stat-val { font-size: 2rem; font-weight: 800; display: block; color: var(--primary); }
        .stat-lbl { font-size: 0.7rem; color: #999; text-transform: uppercase; font-weight: bold; }

        .deck-list { display: flex; flex-direction: column; gap: 10px; }
        .deck-item {
            background: white; padding: 18px; border-radius: 12px; 
            display: flex; justify-content: space-between; align-items: center;
            box-shadow: 0 2px 5px rgba(0,0,0,0.02); cursor: pointer; border: 1px solid #eee;
        }
        .deck-name { font-weight: 700; font-size: 1rem; color: #2c3e50; }
        .deck-badge { background: #eee; padding: 4px 10px; border-radius: 10px; font-size: 0.8rem; color: #666; }

        .btn-main { background: var(--primary); color: white; width: 100%; border: none; padding: 16px; border-radius: 12px; font-size: 1.1rem; font-weight: bold; cursor: pointer; margin-top: 20px; }
        .btn-alt { background: #eef2f5; color: #555; border: none; padding: 10px 15px; border-radius: 10px; font-weight: 600; cursor: pointer; }

        /* --- NAVIGACE --- */
        .bottom-nav {
            position: fixed; bottom: 0; left: 0; width: 100%;
            height: calc(var(--nav-height) + var(--safe-bottom));
            padding-bottom: var(--safe-bottom);
            background: rgba(255,255,255,0.96); border-top: 1px solid rgba(0,0,0,0.05);
            display: flex; justify-content: space-around; align-items: center;
            z-index: 1000; box-shadow: 0 -5px 15px rgba(0,0,0,0.02);
        }
        .nav-btn { 
            flex: 1; height: 100%; display: flex; flex-direction: column; 
            align-items: center; justify-content: center; 
            color: #ccc; font-size: 0.7rem; font-weight: bold; cursor: pointer; 
        }
        .nav-btn.active { color: var(--primary); }
        .nav-icon { font-size: 1.5rem; margin-bottom: 3px; }

        /* --- TEST --- */
        .mode-switch { display: flex; gap: 5px; margin-bottom: 20px; background: #eee; padding: 4px; border-radius: 10px; }
        .mode-opt { flex: 1; padding: 10px; text-align: center; border-radius: 8px; font-weight: bold; color: #666; cursor: pointer; }
        .mode-opt.active { background: white; color: var(--primary); box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        
        .test-btn { width: 100%; padding: 15px; margin-bottom: 10px; background: white; border: 2px solid #eee; border-radius: 10px; text-align: left; font-size: 1rem; cursor: pointer; font-weight: 500; }
        .test-btn.correct { background: #d4edda; border-color: var(--success); }
        .test-btn.wrong { background: #f8d7da; border-color: var(--danger); }
        
        /* Utils */
        .hidden { display: none !important; }
        .input-text { width: 100%; padding: 15px; border: 2px solid #ddd; border-radius: 10px; font-size: 1.1rem; }
        #lightbox { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); z-index: 9000; display: none; justify-content: center; align-items: center; }
        #lightbox img { max-width: 95%; max-height: 95%; border-radius: 8px; }
        .modal-bg { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 6000; display: none; justify-content: center; align-items: center; }
        .modal-box { background: white; width: 90%; max-width: 350px; padding: 25px; border-radius: 15px; text-align: center; }
        .timeline-slot { background: white; padding: 12px; border: 1px solid #ddd; border-radius: 10px; margin-bottom: 8px; display: flex; justify-content: space-between; align-items: center; }
        .t-btn { background: #eee; border: none; padding: 5px 10px; border-radius: 5px; }
    </style>
</head>
<body>

<div class="container">

    <div id="view-home" class="view active">
        <h2>Dƒõjepis 4.6</h2>
        
        <div class="stats-row">
            <div class="stat-box"><span class="stat-val" id="streak">0</span><span class="stat-lbl">Dn√≠ v ≈ôadƒõ</span></div>
            <div class="stat-box"><span class="stat-val" id="total">0</span><span class="stat-lbl">Opakov√°n√≠</span></div>
        </div>

        <h3 style="color:#999; font-size:0.8rem; margin:20px 0 10px 5px; text-transform:uppercase;">Tvoje Sady</h3>
        <div id="deck-list-home" class="deck-list"></div>

        <div style="margin-top:40px; text-align:center;">
            <button class="btn-alt" onclick="document.getElementById('file-in').click()">üìÇ Soubor</button>
            <button class="btn-alt" onclick="openUrl()" style="margin-left:10px;">üåê URL / QR</button>
            <input type="file" id="file-in" class="hidden" onchange="importFile(event)">
            <div style="margin-top:20px; font-size:0.7rem; color:#ccc;" onclick="resetApp()">Reset Dat</div>
        </div>
    </div>

    <div id="view-learn" class="view">
        <h2>üß† Nastaven√≠ uƒçen√≠</h2>
        <p style="text-align:center; color:#666;">Vyber t√©ma:</p>
        <div id="deck-list-learn" class="deck-list"></div>
        <button class="btn-main" onclick="startSession()">Spustit uƒçen√≠ üöÄ</button>
    </div>

    <div id="view-test" class="view">
        <h2>üìù Testov√°n√≠</h2>
        <div class="mode-switch">
            <div class="mode-opt active" id="m-abcd" onclick="setMode('abcd')">ABCD</div>
            <div class="mode-opt" id="m-write" onclick="setMode('write')">Psan√≠</div>
            <div class="mode-opt" id="m-timeline" onclick="setMode('timeline')">Osa</div>
        </div>
        <div id="deck-list-test" class="deck-list"></div>
        <div id="test-len-wrap" style="margin:20px 0;">
            <select id="test-len" style="width:100%; padding:15px; border-radius:10px; border:1px solid #ddd; background:white;">
                <option value="5">5 ot√°zek</option>
                <option value="10">10 ot√°zek</option>
                <option value="15">15 ot√°zek</option>
            </select>
        </div>
        <button class="btn-main" onclick="runTest()">Spustit test</button>
    </div>

    <div id="learn-overlay" class="hidden">
        <div class="learn-header">
            <div class="header-top">
                <span class="pill" id="l-text">Start</span>
                <button class="close-btn" onclick="closeOverlay()">‚úï</button>
            </div>
            <div class="progress-container">
                <div class="progress-fill" id="l-bar"></div>
            </div>
        </div>

        <div class="fc-container" onclick="flipCard()">
            <div class="flashcard" id="card">
                <div class="side front">
                    <div class="q-deck" id="c-deck">T√âMA</div>
                    <img id="c-img-q" class="q-img hidden">
                    <div style="display:inline-block;">
                        <span class="q-text" id="c-q">Ot√°zka</span>
                        <button class="tts-btn" onclick="speak(event, 'c-q')">üîà</button>
                    </div>
                </div>
                <div class="side back">
                    <img id="c-img-a" class="q-img hidden">
                    <div id="c-answers" class="answer-container"></div>
                    <button class="tts-btn" onclick="speak(event, 'c-a-raw')" style="margin-top:15px;">üîà P≈ôeƒç√≠st</button>
                    <div id="c-a-raw" class="hidden"></div>
                </div>
            </div>
        </div>

        <div class="srs-area">
            <div class="hint-text" id="flip-hint">Klikni pro otoƒçen√≠</div>
            <div id="srs-btns" class="srs-buttons srs-grid hidden">
                <button class="srs-btn b-0" onclick="rate(1)">Znovu<span>Hned</span></button>
                <button class="srs-btn b-1" onclick="rate(3)">Tƒõ≈æk√©<span>10m</span></button>
                <button class="srs-btn b-2" onclick="rate(4)">Dobr√©<span>1d</span></button>
                <button class="srs-btn b-3" onclick="rate(5)">Snadn√©<span>4d</span></button>
            </div>
        </div>
    </div>

    <div id="test-overlay" class="hidden" style="position:fixed; top:0; left:0; width:100%; height:100%; background:var(--bg); z-index:5000; padding:20px; display:flex; flex-direction:column; overflow-y:auto;">
        <div style="display:flex; justify-content:space-between; margin-bottom:20px; font-weight:bold;">
            <span id="t-prog">1/10</span>
            <span id="t-pts" style="color:var(--success)">0 b</span>
        </div>
        <div id="t-content" style="flex:1;">
            <div id="t-q" style="font-size:1.4rem; font-weight:bold; text-align:center; margin-bottom:20px;"></div>
            <img id="t-img" class="q-img hidden" style="margin:0 auto; display:block;">
            <div id="t-area"></div>
        </div>
        <button id="t-next" class="btn-main hidden" onclick="nextTQ()" style="background:var(--accent);">Dal≈°√≠ ‚û°Ô∏è</button>
        <button onclick="closeOverlay()" style="background:none; border:none; color:#999; margin-top:20px; padding:10px;">Ukonƒçit test</button>
    </div>

    <div class="bottom-nav">
        <div class="nav-btn active" onclick="tab('home')"><div class="nav-icon">üè†</div>Dom≈Ø</div>
        <div class="nav-btn" onclick="tab('learn')"><div class="nav-icon">üß†</div>Uƒçen√≠</div>
        <div class="nav-btn" onclick="tab('test')"><div class="nav-icon">üìù</div>Test</div>
    </div>

</div>

<div id="url-modal" class="modal-bg">
    <div class="modal-box">
        <h3>Import URL</h3>
        <input id="url-val" style="width:100%; padding:10px; border:1px solid #ddd; border-radius:8px; margin:15px 0;">
        <button onclick="doImportUrl()" style="padding:10px 20px; background:var(--primary); color:white; border:none; border-radius:8px;">Nahr√°t</button>
        <button onclick="document.getElementById('url-modal').style.display='none'" style="padding:10px 20px; background:#eee; border:none; border-radius:8px; margin-left:5px;">Zru≈°it</button>
    </div>
</div>

<div id="lightbox" onclick="this.style.display='none'"><img id="lb-img"></div>

<script>
const DB="HisApp46", V=1; let db, decks={}, queue=[], cC=null, tQ=[], tI=0, tS=0, tM='abcd';
let sessionTotal = 0; // Pro progress bar

const DATA = {
    "Arabsk√° ≈ô√≠≈°e": [
        {q:"Kdo tvo≈ôili vƒõt≈°inu obyvatel Arabsk√©ho poloostrova?", a:["Koƒçovn√≠ pastevci ‚Äì bedu√≠ni"], year:null},
        {q:"Co znamen√° slovo isl√°m?", a:["Odevzdanost Bohu"], year:610},
        {q:"Kdy do≈°lo k hid≈æ≈ôe (odchod z Mekky)?", a:["Rok 622"], year:622},
        {q:"Svat√° kniha muslim≈Ø?", a:["Kor√°n"], year:null},
        {q:"5 pil√≠≈ô≈Ø isl√°mu", a:["V√≠ra","Modlitba","Almu≈æna","P≈Øst","Pou≈•"], year:null},
        {q:"Co je chal√≠f√°t?", a:["Arabsk√° ≈ô√≠≈°e v ƒçele s chal√≠fou"], year:null},
        {q:"Kter√© st√°ty le≈æ√≠ na √∫zem√≠ ovl√°dan√©m Araby?", a:["≈†panƒõlsko","Portugalsko"], year:711},
        {q:"Co je minaret?", a:["Vƒõ≈æ u me≈°ity"], year:null}
    ],
    "Slovan√© a S√°mova ≈ô√≠≈°e": [
        {q:"Kdy p≈ôi≈°li Slovan√© na na≈°e √∫zem√≠?", a:["V 6. stolet√≠"], year:550},
        {q:"Typick√Ω slovansk√Ω d≈Øm?", a:["Polozemnice"], year:null},
        {q:"Kdo byl S√°mo?", a:["Franck√Ω kupec, vl√°dce Slovan≈Ø"], year:623},
        {q:"Kdy a kde porazil S√°mo Franky?", a:["Rok 631 u Wogastisburgu"], year:631},
        {q:"Co se stalo po S√°movƒõ smrti?", a:["≈ò√≠≈°e se rozpadla"], year:658},
        {q:"Hlavn√≠ slovansk√Ω b≈Øh?", a:["Perun"], year:null}
    ]
};

async function init(){await dbOp();decks=await dbGet()||{};if(!Object.keys(decks).length){for(let[n,c]of Object.entries(DATA))decks[n]=c.map(x=>({...x,id:Date.now()+Math.random(),reps:0,interval:0,ef:2.5,nextReview:Date.now()}));await dbSav(decks);}rHome();}
function dbOp(){return new Promise(r=>{const q=indexedDB.open(DB,V);q.onupgradeneeded=e=>e.target.result.createObjectStore('s');q.onsuccess=e=>{db=e.target.result;r()}})}
function dbSav(d){db.transaction('s','readwrite').objectStore('s').put(d,'d')}
function dbGet(){return new Promise(r=>{db.transaction('s','readonly').objectStore('s').get('d').onsuccess=e=>r(e.target.result)})}

// NAVIGACE
function tab(id){
    document.querySelectorAll('.view').forEach(e=>e.classList.remove('active'));
    document.getElementById('view-'+id).classList.add('active');
    document.querySelectorAll('.nav-btn').forEach(e=>e.classList.remove('active'));
    document.querySelector(`.nav-btn[onclick="tab('${id}')"]`).classList.add('active');
    if(id==='home')rHome(); if(id==='learn')rSel('learn'); if(id==='test')rSel('test');
}

function rHome(){
    const l=document.getElementById('deck-list-home');l.innerHTML='';
    let tot=0;Object.keys(decks).forEach(n=>{
        tot+=decks[n].reduce((a,c)=>a+(c.reps||0),0);
        l.innerHTML+=`<div class="deck-item" onclick="goL('${n}')"><span class="deck-name">${n}</span><span class="deck-badge">${decks[n].length}</span></div>`;
    });
    document.getElementById('total').innerText=tot; const s=JSON.parse(localStorage.getItem('h_st'))||{v:0};document.getElementById('streak').innerText=s.v;
}
function goL(n){tab('learn');setTimeout(()=>{const c=document.querySelector(`input[name="learn-d"][value="${n}"]`);if(c){c.checked=true;startSession()}},50)}
function rSel(m){
    const l=document.getElementById('deck-list-'+m);l.innerHTML='';
    Object.keys(decks).forEach(n=>{
        l.innerHTML+=`<label class="deck-item"><span class="deck-name">${n}</span><input type="checkbox" name="${m}-d" value="${n}" style="transform:scale(1.3)"></label>`;
    });
}

// UƒåEN√ç (IMERSIVN√ç S PROGRESS BAREM)
function startSession(){
    const s=Array.from(document.querySelectorAll('input[name="learn-d"]:checked')).map(i=>i.value);
    if(!s.length)return alert("Vyber t√©ma!");
    queue=[];s.forEach(n=>queue.push(...decks[n].filter(x=>x.nextReview<=Date.now())));
    if(!queue.length)return alert("V≈°e um√≠≈°! Zkus to z√≠tra.");
    queue.sort(()=>Math.random()-0.5);
    
    sessionTotal = queue.length; // Ulo≈æ√≠me celkov√Ω poƒçet na zaƒç√°tku
    
    document.getElementById('learn-overlay').classList.remove('hidden');
    nextC();
}

function nextC(){
    if(!queue.length){closeOverlay();return;}
    cC=queue[0];
    
    // Reset UI
    document.getElementById('card').classList.remove('flipped');
    document.getElementById('srs-btns').classList.add('hidden');
    document.getElementById('flip-hint').classList.remove('hidden');
    
    // Update Content
    document.getElementById('c-deck').innerText=cC.deck;
    document.getElementById('c-q').innerText=cC.q;
    
    const ansContainer = document.getElementById('c-answers'); ansContainer.innerHTML='';
    const ans=Array.isArray(cC.a)?cC.a:[cC.a];
    ans.forEach(line=>{ansContainer.innerHTML+=`<div class="answer-line">${line}</div>`});
    
    document.getElementById('c-a-raw').innerText=ans.join('. ');
    const iq=document.getElementById('c-img-q'); if(cC.qImg){iq.src=cC.qImg;iq.classList.remove('hidden')}else iq.classList.add('hidden');
    const ia=document.getElementById('c-img-a'); if(cC.aImg){ia.src=cC.aImg;ia.classList.remove('hidden')}else ia.classList.add('hidden');
    
    // UPDATE PROGRESS BAR
    // Zb√Ωvaj√≠c√≠ karty = queue.length. Hotov√© = sessionTotal - queue.length.
    const done = sessionTotal - queue.length;
    // Poƒç√≠t√°me jen prvn√≠ pr≈Øchod pro progress bar? Nebo dynamicky?
    // Lep≈°√≠ UX: Progress bar ukazuje kolik zb√Ωv√° do konce fronty.
    // Ale pokud se karta vr√°t√≠ (Znovu), fronta se nezmen≈°√≠. To je spr√°vnƒõ.
    
    document.getElementById('l-text').innerText = `Zb√Ωv√°: ${queue.length}`;
    
    // V√Ωpoƒçet procenta: (Start - Aktu√°ln√≠) / Start
    // Pokud se karta vr√°t√≠, queue.length z≈Østane stejn√°, progress se nehne. To je OK.
    const pct = Math.max(0, Math.min(100, ((sessionTotal - queue.length) / sessionTotal) * 100));
    document.getElementById('l-bar').style.width = pct + "%";
}

function flipCard(){document.getElementById('card').classList.add('flipped');document.getElementById('srs-btns').classList.remove('hidden');document.getElementById('flip-hint').classList.add('hidden');}

// SRS LOGIKA (WORLD CLASS SM-2)
function rate(q){
    const c=cC;
    const st=JSON.parse(localStorage.getItem('h_st'))||{v:0,l:''};const d=new Date().toDateString();if(st.l!==d){st.v++;st.l=d;localStorage.setItem('h_st',JSON.stringify(st))}
    
    if(q<3){
        // ZNOVU (AGAIN):
        // 1. Reset statistik karty
        c.reps=0; c.interval=0; c.nextReview=Date.now();
        // 2. P≈ôesun na konec fronty (aby se opakovala TEƒé)
        // Shift u≈æ probƒõhl vizu√°lnƒõ (bereme cC), teƒè ji d√°me na konec.
        queue.shift(); // Vyhod√≠me zep≈ôedu
        queue.push(c); // D√°me dozadu
        // Progress bar se neposune, proto≈æe length je stejn√°
    }
    else{
        // DOB≈òE (PASS):
        c.reps++;
        if(c.reps===1) c.interval=(q===3?0.007:(q===4?1:4)); // 10min, 1d, 4d
        else c.interval=Math.round(c.interval*c.ef);
        
        // SM-2 EF calculation
        c.ef = Math.max(1.3, c.ef + (0.1 - (5 - q) * (0.08 + (5 - q) * 0.02)));
        
        c.nextReview=Date.now()+(c.interval*86400000);
        
        // Ulo≈æit do DB
        const dk=decks[c.deck];const idx=dk.findIndex(x=>x.id===c.id);dk[idx]=c;dbSav(decks);
        
        // Odstranit z fronty
        queue.shift();
    }
    nextC();
}

function speak(e,id){e.stopPropagation();const t=document.getElementById(id).innerText;const u=new SpeechSynthesisUtterance(t);u.lang='cs-CZ';window.speechSynthesis.cancel();window.speechSynthesis.speak(u)}

// TEST
function setMode(m){tM=m;document.querySelectorAll('.mode-opt').forEach(e=>e.classList.remove('active'));document.getElementById('m-'+m).classList.add('active');if(m==='timeline')document.getElementById('test-len-wrap').classList.add('hidden');else document.getElementById('test-len-wrap').classList.remove('hidden');}
function runTest(){
    const s=Array.from(document.querySelectorAll('input[name="test-d"]:checked')).map(i=>i.value);
    if(!s.length)return alert("Vyber t√©ma!");
    let p=[]; s.forEach(n=>p.push(...decks[n]));
    if(tM==='timeline'){p=p.filter(x=>x.year);if(p.length<3)return alert("M√°lo dat s rokem."); p.sort(()=>Math.random()-0.5); tQ=p.slice(0,5);}
    else{const l=parseInt(document.getElementById('test-len').value); p.sort(()=>Math.random()-0.5); tQ=p.slice(0,l);}
    tI=0;tS=0; document.getElementById('test-overlay').classList.remove('hidden'); rTQ();
}
function rTQ(){
    if(tI>=tQ.length){alert(`Hotovo! ${Math.round(tS/tQ.length*100)}%`);closeOverlay();return;}
    const c=tQ[tI]; document.getElementById('t-prog').innerText=`${tI+1}/${tQ.length}`; document.getElementById('t-next').classList.add('hidden');
    const area=document.getElementById('t-area'); area.innerHTML=''; 
    document.getElementById('t-q').innerText=c.q; 
    const img=document.getElementById('t-img'); if(c.qImg){img.src=c.qImg;img.classList.remove('hidden')}else img.classList.add('hidden');

    if(tM==='abcd'){
        const cr=Array.isArray(c.a)?c.a[0]:c.a; const ot=decks[c.deck].filter(x=>x.id!==c.id);
        let b=[];ot.forEach(o=>b.push(Array.isArray(o.a)?o.a[0]:o.a)); b=[...new Set(b)].sort(()=>Math.random()-0.5).slice(0,3);
        let o=[{t:cr,ok:true},...b.map(x=>({t:x,ok:false}))].sort(()=>Math.random()-0.5);
        o.forEach(op=>{
            const bn=document.createElement('div');bn.className='test-btn';bn.innerText=op.t;
            bn.onclick=()=>{if(op.ok){bn.classList.add('correct');tS++}else{bn.classList.add('wrong')}document.querySelectorAll('.test-btn').forEach(e=>e.style.pointerEvents='none');document.getElementById('t-pts').innerText=tS+' b';document.getElementById('t-next').classList.remove('hidden')};
            area.appendChild(bn);
        });
    } else if(tM==='write'){
        area.innerHTML=`<input id="w-in" style="width:100%;padding:15px;border:2px solid #ddd;border-radius:10px;font-size:1.1rem;margin-bottom:15px;" placeholder="Odpovƒõƒè..."><button class="btn-main" onclick="evalW()">Zkontrolovat</button><div id="w-fb" style="text-align:center;margin-top:15px;font-weight:bold"></div>`;
    } else {
        document.getElementById('t-q').innerText="Se≈ôaƒè ud√°losti:"; tL=[...tQ];tL.sort(()=>Math.random()-0.5); drTL();
    }
}
function evalW(){const v=document.getElementById('w-in').value.trim();const c=tQ[tI];const cr=Array.isArray(c.a)?c.a:[c.a];const ok=cr.some(x=>v.toLowerCase().includes(x.toLowerCase().substring(0,4)));const f=document.getElementById('w-fb');if(ok){f.innerHTML="<span style='color:green'>OK!</span>";tS++}else{f.innerHTML="<span style='color:red'>Ne.</span> "+cr[0]}document.getElementById('w-in').disabled=true;document.getElementById('t-pts').innerText=tS+' b';document.getElementById('t-next').classList.remove('hidden')}
let tL=[];
function drTL(){const a=document.getElementById('t-area');a.innerHTML='';tL.forEach((x,i)=>{a.innerHTML+=`<div style="background:white;padding:10px;border:1px solid #ddd;border-radius:8px;margin-bottom:5px;display:flex;justify-content:space-between;align-items:center"><span>${x.q}</span><div><button onclick="mv(${i},-1)" style="padding:5px">‚ñ≤</button><button onclick="mv(${i},1)" style="padding:5px">‚ñº</button></div></div>`}); a.innerHTML+=`<button class="btn-main" onclick="evalTm()">Zkontrolovat</button>`;}
function mv(i,d){const n=i+d;if(n<0||n>=tL.length)return;[tL[i],tL[n]]=[tL[n],tL[i]];drTL()}
function evalTm(){let ok=true;for(let i=0;i<tL.length-1;i++){if(tL[i].year>tL[i+1].year)ok=false}if(ok){alert("Spr√°vnƒõ!");tS+=5}else{alert("Chyba.")}closeOverlay()}
function nextTQ(){tI++;rTQ()}
function closeOverlay(){document.getElementById('learn-overlay').classList.add('hidden');document.getElementById('test-overlay').classList.add('hidden');tab('home')}

// SYS
function openUrl(){document.getElementById('url-modal').style.display='flex'}
function doImportUrl(){const u=document.getElementById('url-val').value;fetch(u).then(r=>r.json()).then(d=>{impP(d);document.getElementById('url-modal').style.display='none'}).catch(e=>alert("Err"))}
function importFile(e){const r=new FileReader();r.onload=v=>impP(JSON.parse(v.target.result));r.readAsText(e.target.files[0])}
function impP(d){const c=decks;Object.keys(d).forEach(k=>{if(!c[k])c[k]=[];const n=Array.isArray(d)?d:d[k];c[k]=[...c[k],...n.map(x=>({...x,id:Date.now()+Math.random(),reps:0,interval:0,ef:2.5,nextReview:Date.now()}))]});dbSav(decks);alert("OK");rHome()}
function fullReset(){if(confirm("Smazat?")){indexedDB.deleteDatabase(DB);localStorage.clear();location.reload()}}

if('serviceWorker' in navigator)navigator.serviceWorker.register('sw.js');
init();
</script>
</body>
</html>