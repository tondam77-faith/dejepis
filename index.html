<!DOCTYPE html>
<html lang="cs">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <link rel="manifest" href="manifest.json">
    <link rel="icon" href="favicon.ico" type="image/x-icon">
    <meta name="theme-color" content="#fdfbf7">
    <title>Dƒõjepis - Super App v2.2</title>
    <style>
        :root {
            --primary: #1a3a5a; --accent: #e67e22; --bg: #fdfbf7;
            --card-front: #ffffff; --highlight: #ffce54; --danger: #e74c3c; --gray: #95a5a6;
            --success: #27ae60; --nav-height: 70px;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

        body {
            font-family: 'Segoe UI', system-ui, sans-serif;
            background-color: var(--bg); margin: 0; 
            height: 100vh; color: #2c3e50; overflow: hidden;
            display: flex; flex-direction: column;
        }

        /* --- HLAVN√ç KONTEJNER (Centrov√°n√≠) --- */
        .container { 
            width: 100%; max-width: 600px; margin: 0 auto;
            flex: 1; display: flex; flex-direction: column;
            overflow-y: hidden; position: relative;
        }

        .view {
            flex: 1; overflow-y: auto; padding: 15px; 
            padding-bottom: 90px; /* M√≠sto pro li≈°tu */
            display: none;
        }
        .view.active { display: flex; flex-direction: column; animation: fadeIn 0.3s; }

        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        /* --- SPODN√ç NAVIGACE --- */
        .bottom-nav {
            position: absolute; bottom: 0; left: 0; width: 100%; height: var(--nav-height);
            background: white; border-top: 1px solid #e2ddd3;
            display: flex; justify-content: space-around; align-items: center;
            box-shadow: 0 -4px 20px rgba(0,0,0,0.05); z-index: 1000;
        }
        .nav-item {
            display: flex; flex-direction: column; align-items: center;
            color: #999; font-size: 0.75rem; cursor: pointer;
            width: 100%; height: 100%; justify-content: center; transition: 0.2s;
        }
        .nav-item.active { color: var(--primary); transform: translateY(-2px); }
        .nav-icon { font-size: 1.6rem; margin-bottom: 3px; }

        /* --- UI PRVKY --- */
        h2 { color: var(--primary); margin-top: 0; text-align: center; }
        .card-box { background: white; padding: 20px; border-radius: 20px; box-shadow: 0 4px 15px rgba(0,0,0,0.03); margin-bottom: 15px; border: 1px solid #e2ddd3; }
        
        .btn-main { background: var(--primary); color: white; border: none; padding: 15px; border-radius: 12px; width: 100%; font-weight: bold; font-size: 1.1rem; cursor: pointer; transition: background 0.2s; }
        .btn-main:active { background: #132c45; }
        
        .btn-alt { background: var(--accent); color: white; border: none; padding: 10px 15px; border-radius: 8px; font-weight: bold; cursor: pointer; font-size: 0.9rem; }
        .deck-item { display: flex; justify-content: space-between; align-items: center; background: white; padding: 15px; border-radius: 12px; margin-bottom: 10px; border: 1px solid #ddd; cursor: pointer; box-shadow: 0 2px 5px rgba(0,0,0,0.02); }
        .deck-name { font-weight: bold; font-size: 1.05rem; }

        /* --- UƒåEN√ç (FLIP KARTY) --- */
        .fc-container { perspective: 1000px; flex: 1; display: flex; align-items: center; justify-content: center; min-height: 300px; margin: 10px 0; }
        .fc-card { position: relative; width: 100%; height: 100%; transition: transform 0.6s cubic-bezier(0.4, 0, 0.2, 1); transform-style: preserve-3d; }
        .fc-card.flipped { transform: rotateY(180deg); }
        .fc-front, .fc-back { position: absolute; width: 100%; height: 100%; backface-visibility: hidden; border-radius: 24px; padding: 25px; display: flex; flex-direction: column; justify-content: center; align-items: center; text-align: center; box-shadow: 0 10px 30px rgba(26, 58, 90, 0.15); background: var(--card-front); border: 1px solid #f0f0f0; overflow-y: auto; }
        .fc-back { background: var(--primary); color: white; transform: rotateY(180deg); }
        
        .q-text { font-size: 1.5rem; font-weight: bold; line-height: 1.4; }
        .q-img { max-height: 150px; border-radius: 8px; margin-bottom: 15px; object-fit: contain; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
        
        /* Odpovƒõdi - seznam */
        .a-list { text-align: left; width: 100%; padding-left: 10px; font-size: 1.2rem; }
        .a-item { margin-bottom: 8px; display: flex; align-items: flex-start; }
        .a-bullet { color: var(--highlight); margin-right: 10px; font-weight: bold; }

        /* --- SRS TLAƒå√çTKA --- */
        #srs-buttons { display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; width: 100%; margin-top: auto; }
        .srs-btn { border: none; padding: 12px 2px; border-radius: 12px; color: white; font-weight: bold; cursor: pointer; font-size: 0.85rem; display: flex; flex-direction: column; align-items: center; }
        .srs-btn span { font-size: 0.65rem; font-weight: normal; margin-top: 3px; opacity: 0.9; }
        .b-0 { background: var(--danger); } .b-1 { background: var(--accent); } .b-2 { background: #3498db; } .b-3 { background: var(--success); }

        /* --- TESTOV√ÅN√ç --- */
        .mode-switch { display: flex; gap: 10px; margin-bottom: 20px; background: #eee; padding: 5px; border-radius: 12px; }
        .mode-btn { flex: 1; padding: 10px; border-radius: 8px; background: transparent; cursor: pointer; text-align: center; font-weight: bold; color: #666; transition: 0.2s; }
        .mode-btn.selected { background: white; color: var(--primary); box-shadow: 0 2px 5px rgba(0,0,0,0.1); }

        .test-btn { background: white; border: 2px solid #e2ddd3; padding: 15px; border-radius: 12px; text-align: left; font-size: 1.1rem; cursor: pointer; margin-bottom: 10px; font-weight: 500; transition: 0.2s; }
        .test-btn:hover { border-color: var(--primary); }
        .test-btn.correct { background: #d4edda; border-color: #27ae60; color: #155724; }
        .test-btn.wrong { background: #f8d7da; border-color: #c0392b; color: #721c24; }
        
        .input-write { width: 100%; padding: 15px; border: 2px solid #ddd; border-radius: 12px; font-size: 1.1rem; outline: none; }
        .input-write:focus { border-color: var(--primary); }

        .hidden { display: none !important; }
        
        /* Progress Bar */
        .progress-container { width: 100%; height: 8px; background: #ddd; border-radius: 4px; margin-bottom: 10px; overflow: hidden; }
        .progress-fill { height: 100%; background: var(--success); width: 0%; transition: width 0.3s; }
    </style>
</head>
<body>

<div class="container">

    <div id="view-home" class="view active">
        <h2 style="margin-bottom:5px;">Dƒõjepis SRS 2.2</h2>
        <p style="text-align:center; margin-top:0; color:#666;">Chytr√© uƒçen√≠ & Testov√°n√≠</p>
        
        <div class="card-box" style="display:flex; justify-content:space-around; text-align:center;">
            <div>
                <div style="font-size:1.5rem; font-weight:bold; color:var(--accent);">üî• <span id="home-streak">0</span></div>
                <div style="font-size:0.7rem; text-transform:uppercase;">Dn√≠ v ≈ôadƒõ</div>
            </div>
            <div>
                <div style="font-size:1.5rem; font-weight:bold; color:var(--primary);"><span id="prof-mastered">0</span></div>
                <div style="font-size:0.7rem; text-transform:uppercase;">Um√≠m</div>
            </div>
        </div>

        <h3>üìö T√©mata</h3>
        <div id="home-deck-list"></div>
        
        <div style="margin-top:20px; text-align:center;">
            <button class="btn-alt" style="background:#eee; color:#666; font-size:0.8rem;" onclick="document.getElementById('file-in').click()">üìÇ Nahr√°t data</button>
            <input type="file" id="file-in" class="hidden" onchange="importData(event)">
            <div style="margin-top:10px; font-size:0.7rem; color:#ccc;" onclick="fullReset()">Verze 2.2 (Klikni pro reset)</div>
        </div>
    </div>

    <div id="view-learn" class="view">
        <div id="learn-setup">
            <h2>üß† Uƒçen√≠</h2>
            <p style="text-align:center;">Vyber t√©ma k opakov√°n√≠:</p>
            <div id="learn-deck-list"></div>
            <button class="btn-main" onclick="startLearningSession()" style="margin-top:20px;">Spustit uƒçen√≠ üöÄ</button>
        </div>

        <div id="learn-active" class="hidden" style="height:100%; display:flex; flex-direction:column;">
            <div style="display:flex; justify-content:space-between; font-weight:bold; color:var(--primary);">
                <span id="learn-progress">1 / 10</span>
                <span style="cursor:pointer; color:var(--danger);" onclick="exitMode()">Ukonƒçit</span>
            </div>
            <div class="progress-container"><div id="learn-bar" class="progress-fill"></div></div>

            <div class="fc-container" onclick="flipCard()">
                <div class="fc-card" id="fc-card">
                    <div class="fc-front">
                        <div style="font-size:0.75rem; color:var(--accent); text-transform:uppercase; margin-bottom:10px; font-weight:bold;" id="fc-deck-name"></div>
                        <img id="fc-img-q" class="q-img hidden">
                        <div class="q-text" id="fc-q"></div>
                    </div>
                    <div class="fc-back">
                        <img id="fc-img-a" class="q-img hidden">
                        <div id="fc-a"></div>
                    </div>
                </div>
            </div>
            
            <div id="flip-hint" style="text-align:center; color:#999; font-size:0.8rem; margin-bottom:10px;">Klikni pro otoƒçen√≠</div>

            <div id="srs-buttons" class="hidden">
                <button class="srs-btn b-0" onclick="rateCard(1)">Znovu<span>&lt;1m</span></button>
                <button class="srs-btn b-1" onclick="rateCard(3)">Tƒõ≈æk√©<span>10m</span></button>
                <button class="srs-btn b-2" onclick="rateCard(4)">Dobr√©<span>1d</span></button>
                <button class="srs-btn b-3" onclick="rateCard(5)">Snadn√©<span>4d</span></button>
            </div>
        </div>
    </div>

    <div id="view-test" class="view">
        <div id="test-setup">
            <h2>üìù Testov√°n√≠</h2>
            <div class="mode-switch">
                <div class="mode-btn selected" id="mode-abcd" onclick="setTestMode('abcd')">üî† ABCD</div>
                <div class="mode-btn" id="mode-write" onclick="setTestMode('write')">‚úçÔ∏è Psan√≠</div>
            </div>
            
            <p style="text-align:center;">Vyber t√©ma:</p>
            <div id="test-deck-list"></div>
            
            <div style="margin-top:15px; margin-bottom:20px;">
                <label style="font-size:0.9rem; font-weight:bold;">Poƒçet ot√°zek:</label>
                <select id="test-count" style="width:100%; padding:12px; border-radius:8px; border:1px solid #ddd; background:white; font-size:1rem; margin-top:5px;">
                    <option value="5">5 ot√°zek (Rychlovka)</option>
                    <option value="10">10 ot√°zek (Standard)</option>
                    <option value="15">15 ot√°zek (Velk√Ω test)</option>
                </select>
            </div>
            
            <button class="btn-main" onclick="startTestSession()">Spustit test</button>
        </div>
        
        <div id="test-active" class="hidden">
            <div style="display:flex; justify-content:space-between; margin-bottom:10px; font-weight:bold;">
                <span id="test-progress-txt">1/10</span>
                <span id="test-score" style="color:var(--success);">0 bod≈Ø</span>
            </div>
            <div class="progress-container"><div id="test-bar" class="progress-fill"></div></div>

            <img id="test-img" class="q-img hidden" style="margin:0 auto; display:block;">
            <div class="q-text" id="test-q" style="margin-bottom:20px; text-align:center;"></div>
            
            <div id="test-options" style="display:grid; gap:10px;"></div>
            
            <div id="test-write-area" class="hidden">
                <input type="text" id="test-input" class="input-write" placeholder="Napi≈° odpovƒõƒè..." autocomplete="off">
                <button class="btn-main" onclick="evaluateWrite()" style="margin-top:15px;">Zkontrolovat</button>
                <div id="write-feedback" style="margin-top:15px; text-align:center; font-size:1.1rem; font-weight:bold;"></div>
            </div>

            <button id="test-next-btn" class="btn-main hidden" onclick="nextTestQuestion()" style="margin-top:20px; background:var(--accent);">Dal≈°√≠ ot√°zka ‚û°Ô∏è</button>
        </div>

        <div id="test-result" class="hidden" style="text-align:center; padding-top:40px;">
            <h2>üéâ Hotovo!</h2>
            <div style="font-size:3.5rem; margin:20px 0; font-weight:bold; color:var(--primary);" id="test-final-score">100%</div>
            <p id="test-msg" style="color:#666; margin-bottom:30px;">Skvƒõl√° pr√°ce!</p>
            <button class="btn-main" onclick="exitMode()">Zpƒõt do menu</button>
        </div>
    </div>

    <nav class="bottom-nav">
        <div class="nav-item active" onclick="switchTab('home')"><div class="nav-icon">üè†</div>Dom≈Ø</div>
        <div class="nav-item" onclick="switchTab('learn')"><div class="nav-icon">üß†</div>Uƒçen√≠</div>
        <div class="nav-item" onclick="switchTab('test')"><div class="nav-icon">üìù</div>Test</div>
    </nav>

</div>

<script>
    const DB_NAME = "HistoryAppDB"; const DB_VERSION = 2;
    let db, decks = {}, testMode = 'abcd';

    // --- KOMPLETN√ç DATA PRO Z≈† (30 karet) ---
    const INITIAL_DATA = {
        "Arabsk√° ≈ô√≠≈°e": [
            { q: "Kdo tvo≈ôili vƒõt≈°inu obyvatel Arabsk√©ho poloostrova a jak ≈æili?", a: ["Koƒçovn√≠ pastevci ‚Äì bedu√≠ni.", "≈Ωili v kmenech, kter√© spolu ƒçasto bojovaly."], year: null },
            { q: "Co znamen√° v p≈ôekladu slovo isl√°m?", a: ["Odevzdanost Bohu."], year: 610 },
            { q: "Ve kter√©m stolet√≠ se zrodil isl√°m?", a: ["V 7. stolet√≠."], year: 610 },
            { q: "Kdo je podle isl√°mu jedin√Ω B≈Øh a kdo je jeho prorok?", a: ["B≈Øh: All√°h.", "Prorok: Muhammad (Mohamed)."], year: null },
            { q: "Jak se jmenuje posv√°tn√° kniha muslim≈Ø?", a: ["Kor√°n."], year: null },
            { q: "Vyjmenuj 5 pil√≠≈ô≈Ø (povinnost√≠) isl√°mu.", a: ["V√≠ra v jednoho All√°ha", "Modlitba 5x dennƒõ", "Almu≈æna chud√Ωm", "P≈Øst v mƒõs√≠ci Ramad√°nu", "Pou≈• do Mekky"], year: null },
            { q: "Co je to chal√≠f√°t?", a: ["Jednotn√° arabsk√° ≈ô√≠≈°e, v jej√≠m≈æ ƒçele st√°li chal√≠fov√© (n√°stupci proroka)."], year: null },
            { q: "Kam a≈æ sahala Arabsk√° ≈ô√≠≈°e v dobƒõ sv√©ho nejvƒõt≈°√≠ho rozmachu?", a: ["Od Atlantsk√©ho oce√°nu p≈ôes severn√≠ Afriku a≈æ k hranic√≠m Indie."], year: null },
            { q: "Kter√© dne≈°n√≠ evropsk√© st√°ty le≈æ√≠ na Pyrenejsk√©m poloostrovƒõ, kter√Ω Arabov√© ovl√°dali?", a: ["≈†panƒõlsko", "Portugalsko"], year: 711 },
            { q: "Jak se jmenoval kupec, kter√Ω v 10. stolet√≠ nav≈°t√≠vil ƒçesk√© zemƒõ a popsal Prahu?", a: ["Ibrahim ibn J√°kub."], year: 965 },
            { q: "V jak√Ωch vƒõd√°ch Arabov√© vynikali nad tehdej≈°√≠ Evropou?", a: ["Matematika a fyzika", "Zemƒõpis", "L√©ka≈ôstv√≠"], year: null },
            { q: "Jak√© nov√© plodiny p≈ôinesli Arabov√© do Evropy?", a: ["R√Ω≈æe", "Bavlna", "Citrony a pomeranƒçe"], year: null },
            { q: "Proƒç jsou isl√°msk√© stavby zdobeny geometrick√Ωmi vzory nam√≠sto postav?", a: ["Proto≈æe Kor√°n zakazuje zobrazovat lidsk√© postavy."], year: null },
            { q: "Jak se naz√Ωv√° ≈°t√≠hl√° vƒõ≈æ u me≈°ity?", a: ["Minaret."], year: null },
            { q: "Kter√© mƒõsto je nejposv√°tnƒõj≈°√≠ a co je v nƒõm uct√≠v√°no?", a: ["Mƒõsto Mekka.", "Z√°hadn√Ω ƒçern√Ω k√°men (meteoritu) v chr√°mu Ka'ba."], year: null }
        ],
        "Slovan√© a S√°mova ≈ô√≠≈°e": [
            { q: "Kdy p≈ôi≈°li Slovan√© na na≈°e √∫zem√≠?", a: ["V 5. a≈æ 6. stolet√≠.", "V r√°mci tzv. druh√© vlny stƒõhov√°n√≠ n√°rod≈Ø."], year: 550 },
            { q: "Kde byla p≈Øvodn√≠ pravlast Slovan≈Ø?", a: ["Ve v√Ωchodn√≠ Evropƒõ.", "Mezi ≈ôekami Vislou a Dnƒõprem."], year: null },
            { q: "Do kter√Ωch t≈ô√≠ smƒõr≈Ø se Slovan√© vydali z pravlasti?", a: ["Na jih (Balk√°n), na z√°pad (st≈ôedn√≠ Evropa) a na v√Ωchod."], year: null },
            { q: "Jak se naz√Ωval typick√Ω slovansk√Ω d≈Øm?", a: ["Polozemnice.", "ƒå√°steƒçnƒõ zahlouben√° chata."], year: null },
            { q: "V ƒçem spoƒç√≠valo dvojpoln√≠ hospod√°≈ôstv√≠?", a: ["Pole se rozdƒõlilo: polovina se osela, druh√° odpoƒç√≠vala (√∫hor)."], year: null },
            { q: "V co vƒõ≈ôili sta≈ô√≠ Slovan√© p≈ôed p≈ôijet√≠m k≈ôes≈•anstv√≠?", a: ["Byli pohan√©.", "Uct√≠vali p≈ô√≠rodn√≠ s√≠ly (nap≈ô. Perun)."], year: null },
            { q: "Kdo byl S√°mo?", a: ["Franck√Ω kupec.", "Slovan√© si ho zvolili za v≈Ødce."], year: 623 },
            { q: "Proƒç vznikla S√°mova ≈ô√≠≈°e?", a: ["Jako obrana proti Avar≈Øm a Frank≈Øm."], year: 623 },
            { q: "Ve kter√©m stolet√≠ existovala S√°mova ≈ô√≠≈°e?", a: ["V 7. stolet√≠."], year: 623 },
            { q: "Jak se jmenovala v√≠tƒõzn√° bitva Slovan≈Ø proti Frank≈Øm roku 631?", a: ["Bitva u Wogastisburgu."], year: 631 },
            { q: "Kter√©ho fransk√©ho kr√°le S√°mo porazil v bitvƒõ u Wogastisburgu?", a: ["Dagoberta I."], year: 631 },
            { q: "Kter√Ω jedin√Ω p√≠semn√Ω pramen n√°s informuje o S√°movƒõ ≈ô√≠≈°i?", a: ["Fredegarova kronika."], year: 660 },
            { q: "Co se stalo s ≈ô√≠≈°√≠ po S√°movƒõ smrti?", a: ["Rozpadla se a zanikla."], year: 658 },
            { q: "Kter√© ≈ôemesln√© p≈ôedmƒõty se dochovaly v hrobech?", a: ["≈†perky, zbranƒõ, ostruhy, n√°stroje."], year: null },
            { q: "Vyjmenuj prvn√≠ slovansk√© st√°ty.", a: ["Velk√° Morava, Bulharsko, Polsko, Kyjevsk√° Rus."], year: 833 }
        ]
    };

    // --- START ---
    async function init() {
        await dbOpen();
        decks = await dbLoad() || {};
        
        // Pokud je DB pr√°zdn√°, nahrajeme data
        if (Object.keys(decks).length === 0) {
            for (let [name, cards] of Object.entries(INITIAL_DATA)) {
                decks[name] = cards.map((c, i) => ({ ...c, id: Date.now()+i, deck: name, reps: 0, interval: 0, ef: 2.5, nextReview: Date.now() }));
            }
            await dbSave(decks);
        }
        renderHome();
    }

    // --- DB UTILS ---
    async function dbOpen() { return new Promise(r => { const req = indexedDB.open(DB_NAME, DB_VERSION); req.onupgradeneeded = e => e.target.result.createObjectStore("store"); req.onsuccess = e => { db = e.target.result; r(); }; }); }
    async function dbSave(d) { const tx = db.transaction("store", "readwrite"); tx.objectStore("store").put(d, "decks"); }
    async function dbLoad() { return new Promise(r => { const tx = db.transaction("store", "readonly"); const req = tx.objectStore("store").get("decks"); req.onsuccess = () => r(req.result); }); }

    // --- NAVIGACE ---
    function switchTab(id) {
        document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
        document.getElementById('view-'+id).classList.add('active');
        document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
        document.querySelector(`.nav-item[onclick="switchTab('${id}')"]`).classList.add('active');
        if(id === 'home') renderHome();
        if(id === 'learn' || id === 'test') renderDeckSelect(id);
    }

    function renderHome() {
        const list = document.getElementById('home-deck-list'); list.innerHTML = "";
        let masterCount = 0, totalCount = 0;
        
        Object.keys(decks).forEach(n => {
            const cnt = decks[n].length;
            totalCount += cnt;
            masterCount += decks[n].filter(c => c.interval > 14).length;
            list.innerHTML += `<div class="deck-item" onclick="switchTab('learn')"><span>${n}</span> <span style="color:#999; font-size:0.9rem;">${cnt} karet</span></div>`;
        });

        const stats = JSON.parse(localStorage.getItem('hist_stats')) || {streak:0};
        document.getElementById('home-streak').innerText = stats.streak;
        document.getElementById('prof-mastered').innerText = Math.round((masterCount/totalCount)*100 || 0) + "%";
    }

    function renderDeckSelect(mode) {
        const list = document.getElementById(mode+'-deck-list'); list.innerHTML = "";
        Object.keys(decks).forEach(n => list.innerHTML += `<div class="deck-item"><label style="flex:1; display:flex; align-items:center; cursor:pointer;"><input type="checkbox" name="${mode}-deck" value="${n}" style="transform:scale(1.5); margin-right:15px;"> ${n}</label></div>`);
    }

    function exitMode() {
        document.getElementById('learn-active').classList.add('hidden');
        document.getElementById('test-active').classList.add('hidden');
        document.getElementById('test-result').classList.add('hidden');
        document.getElementById('learn-setup').classList.remove('hidden');
        document.getElementById('test-setup').classList.remove('hidden');
        switchTab('home');
    }

    // --- UƒåEN√ç (VA≈†E SRS LOGIKA - HNED, 10min, 1d, 4d) ---
    let learnQ = [], currCard = null;
    
    function startLearningSession() {
        const sel = Array.from(document.querySelectorAll('input[name="learn-deck"]:checked')).map(i=>i.value);
        if(!sel.length) return alert("Vyber t√©ma!");
        learnQ = []; sel.forEach(n => learnQ.push(...decks[n].filter(c => c.nextReview <= Date.now())));
        if(!learnQ.length) return alert("V≈°e um√≠≈°! Zkus to z√≠tra.");
        
        // Zam√≠chat
        learnQ.sort(() => Math.random() - 0.5);
        
        document.getElementById('learn-setup').classList.add('hidden');
        document.getElementById('learn-active').classList.remove('hidden');
        nextLearnCard();
    }

    function nextLearnCard() {
        if(!learnQ.length) return exitMode();
        currCard = learnQ[0];
        
        // Reset
        document.getElementById('fc-card').classList.remove('flipped');
        document.getElementById('srs-buttons').classList.add('hidden');
        document.getElementById('flip-hint').classList.remove('hidden');
        
        // Obsah
        document.getElementById('fc-deck-name').innerText = currCard.deck;
        document.getElementById('fc-q').innerText = currCard.q;
        
        // Odpovƒõƒè (seznam)
        const aContent = Array.isArray(currCard.a) ? 
            currCard.a.map(i => `<div class="a-item"><span class="a-bullet">‚Ä¢</span><span>${i}</span></div>`).join('') : 
            `<div class="a-item"><span class="a-bullet">‚Ä¢</span><span>${currCard.a}</span></div>`;
        document.getElementById('fc-a').innerHTML = `<div class="a-list">${aContent}</div>`;
        
        // Obr√°zky
        const imgQ = document.getElementById('fc-img-q');
        if(currCard.qImg) { imgQ.src = currCard.qImg; imgQ.classList.remove('hidden'); } else imgQ.classList.add('hidden');
        const imgA = document.getElementById('fc-img-a');
        if(currCard.aImg) { imgA.src = currCard.aImg; imgA.classList.remove('hidden'); } else imgA.classList.add('hidden');

        document.getElementById('learn-progress').innerText = `Zb√Ωv√°: ${learnQ.length}`;
        const total = document.querySelectorAll('input[name="learn-deck"]:checked').length * 15; // Odhad
        document.getElementById('learn-bar').style.width = Math.min(100, 100 - (learnQ.length/10)*100) + "%"; // Jen vizu√°ln√≠ efekt
    }

    window.flipCard = () => { 
        document.getElementById('fc-card').classList.add('flipped'); 
        document.getElementById('srs-buttons').classList.remove('hidden');
        document.getElementById('flip-hint').classList.add('hidden');
    };

    // --- VA≈†E SRS LOGIKA (Fixed) ---
    window.rateCard = (q) => {
        const c = currCard;
        // Statistiky
        let stats = JSON.parse(localStorage.getItem('hist_stats'))||{streak:0, last:''};
        const today = new Date().toDateString();
        if(stats.last !== today) { stats.streak++; stats.last = today; localStorage.setItem('hist_stats', JSON.stringify(stats)); }

        // Algoritmus Z≈†: Znovu(hned), 10min, 1den, 4dny
        if(q < 3) { 
            c.reps = 0; c.interval = 0; c.nextReview = Date.now();
            learnQ.push(learnQ.shift()); // P≈ôesunout na konec fronty (hned)
        } else {
            if(c.reps === 0) {
                if(q === 3) c.interval = 0.007; // ~10 min
                else if(q === 4) c.interval = 1; // 1 den
                else c.interval = 4; // 4 dny
            } else {
                // Dal≈°√≠ opakov√°n√≠: interval * efektivita
                if(c.interval < 0.01) c.interval = 1;
                else c.interval = Math.round(c.interval * c.ef);
            }
            c.reps++;
            c.ef = Math.max(1.3, c.ef + (0.1 - (5-q)*(0.08 + (5-q)*0.02)));
            c.nextReview = Date.now() + (c.interval * 86400000);
            
            // Ulo≈æit a odebrat z fronty
            const idx = decks[c.deck].findIndex(x=>x.id===c.id); decks[c.deck][idx]=c; dbSave(decks);
            learnQ.shift();
        }
        nextLearnCard();
    }

    // --- TESTOV√ÅN√ç (ABCD + Write) ---
    let testQ = [], testScore = 0, testIdx = 0;
    function setTestMode(m) { testMode = m; document.querySelectorAll('.mode-btn').forEach(b => b.classList.remove('selected')); document.getElementById('mode-'+m).classList.add('selected'); }

    function startTestSession() {
        const sel = Array.from(document.querySelectorAll('input[name="test-deck"]:checked')).map(i=>i.value);
        if(!sel.length) return alert("Vyber t√©ma!");
        const limit = parseInt(document.getElementById('test-count').value);
        
        let pool = []; sel.forEach(n => pool.push(...decks[n]));
        pool.sort(()=>Math.random()-0.5);
        testQ = pool.slice(0, limit); 
        testScore = 0; testIdx = 0;
        
        document.getElementById('test-setup').classList.add('hidden');
        document.getElementById('test-active').classList.remove('hidden');
        renderTestQ();
    }

    function renderTestQ() {
        if(testIdx >= testQ.length) return finishTest();
        const c = testQ[testIdx];
        document.getElementById('test-q').innerText = c.q;
        document.getElementById('test-progress-txt').innerText = `${testIdx+1}/${testQ.length}`;
        document.getElementById('test-bar').style.width = ((testIdx)/testQ.length)*100 + "%";
        document.getElementById('test-next-btn').classList.add('hidden');
        
        const img = document.getElementById('test-img');
        if(c.qImg) { img.src = c.qImg; img.classList.remove('hidden'); } else img.classList.add('hidden');

        if(testMode === 'abcd') {
            document.getElementById('test-options').style.display = 'grid';
            document.getElementById('test-write-area').classList.add('hidden');
            const container = document.getElementById('test-options'); container.innerHTML = "";
            
            // N√°hodn√Ω z√°stupce
            const correctTxt = Array.isArray(c.a) ? c.a[Math.floor(Math.random()*c.a.length)] : c.a;
            // Distraktory
            const others = decks[c.deck].filter(x=>x.id!==c.id);
            let bads = [];
            others.forEach(o => { if(Array.isArray(o.a)) bads.push(...o.a); else bads.push(o.a); });
            bads = [...new Set(bads)].sort(()=>Math.random()-0.5).slice(0,3);
            
            let opts = [{t:correctTxt, ok:true}, ...bads.map(b=>({t:b, ok:false}))].sort(()=>Math.random()-0.5);
            
            opts.forEach(o => {
                const b = document.createElement('div'); b.className = 'test-btn'; b.innerText = o.t;
                b.onclick = () => {
                    document.querySelectorAll('.test-btn').forEach(x=>x.style.pointerEvents='none');
                    if(o.ok) { b.classList.add('correct'); testScore++; } else { b.classList.add('wrong'); }
                    document.getElementById('test-score').innerText = testScore + " bod≈Ø";
                    document.getElementById('test-next-btn').classList.remove('hidden');
                };
                container.appendChild(b);
            });
        } else {
            document.getElementById('test-options').style.display = 'none';
            document.getElementById('test-write-area').classList.remove('hidden');
            document.getElementById('test-input').value = "";
            document.getElementById('test-input').disabled = false;
            document.getElementById('write-feedback').innerText = "";
            document.getElementById('test-input').focus();
        }
    }

    function evaluateWrite() {
        const inp = document.getElementById('test-input');
        const val = inp.value.trim().toLowerCase();
        const c = testQ[testIdx];
        const correctArr = Array.isArray(c.a) ? c.a : [c.a];
        
        const norm = s => s.normalize("NFD").replace(/[\u0300-\u036f]/g, "");
        const isOk = correctArr.some(ans => norm(ans.toLowerCase()).includes(norm(val)) && val.length > 2);

        const fb = document.getElementById('write-feedback');
        if(isOk) {
            fb.innerHTML = "<span style='color:var(--success)'>Spr√°vnƒõ!</span>";
            testScore++;
        } else {
            fb.innerHTML = "<span style='color:var(--danger)'>Chyba.</span><br><span style='font-size:0.9rem; font-weight:normal'>Spr√°vnƒõ: " + correctArr.join(", ") + "</span>";
        }
        inp.disabled = true;
        document.getElementById('test-score').innerText = testScore + " bod≈Ø";
        document.getElementById('test-next-btn').classList.remove('hidden');
    }

    function nextTestQuestion() { testIdx++; renderTestQ(); }

    function finishTest() {
        document.getElementById('test-active').classList.add('hidden');
        document.getElementById('test-result').classList.remove('hidden');
        document.getElementById('test-final-score').innerText = Math.round((testScore/testQ.length)*100)+"%";
    }

    // --- IMPORT ---
    function importData(e) {
        const f = e.target.files[0]; if(!f)return;
        const r = new FileReader();
        r.onload = async (v) => {
            try {
                const d = JSON.parse(v.target.result);
                if(Array.isArray(d)) { const n = prompt("Jak pojmenovat tento bal√≠ƒçek?"); if(n) { decks[n] = d.map(c => ({...c, deck:n, id: c.id || Date.now()+Math.random(), reps:0, interval:0, ef:2.5, nextReview:Date.now()})); }} 
                else { decks = {...decks, ...d}; }
                await dbSave(decks); alert("Hotovo!"); renderHome();
            } catch(err) { alert("Chyba dat"); }
        };
        r.readAsText(f);
    }

    function fullReset() {
        if(confirm("Opravdu vymazat data a zaƒç√≠t znovu?")) {
            indexedDB.deleteDatabase(DB_NAME);
            localStorage.clear();
            location.reload();
        }
    }

    if('serviceWorker' in navigator) navigator.serviceWorker.register('sw.js');
    init();
</script>
</body>
</html>